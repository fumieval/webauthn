<html>
<head>
  <script src="/base64js.min.js"></script>
  <script src="/util.js"></script>
  <script src="/cbor.js"></script>
</head>
<body>
  <button id="login">Login</login>
  <script>
    document.getElementById("login").addEventListener("click"
      , function(e){
        getJSON("/challenge", function(challenge){
          let rawChallenge = base64js.toByteArray(challenge);
          let info =
              { challenge: rawChallenge
              , user: {
                id: new Uint8Array(16),
                name: "Fumiaki Kinoshita",
                displayName: "fumieval"
                }
              , timeout: 60000
              , rp: {name: "localhost"}
              , pubKeyCredParams:
                [{ type: "public-key"
                , alg: -7
                }]
              , attestation: "direct"}
          navigator.credentials.create({publicKey: info})
            .then((cred) => {
              console.log("NEW CREDENTIAL", cred);
              CBOR.encode(cred.response);
              postJSON("/verify"
                , CBOR.encode([rawChallenge
                    , new Uint8Array(cred.response.attestationObject)
                    , new Uint8Array(cred.response.clientDataJSON)])
                , function(resp)
                  {
                    console.log(resp);
                  });
            })
            .catch((err) => {
              console.log("ERROR", err);
            });
        });
      }
    );
  </script>
</body>
</html>
